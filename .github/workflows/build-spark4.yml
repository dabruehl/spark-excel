name: Build Spark 4.0.0 (Scala 2.13)

on:
  workflow_dispatch:
  push:
    branches: [ "**" ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      SCALA_VERSION: "2.13.16"
      SPARK_VERSION: "4.0.0"

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      # Download Temurin JDK 17 (Spark 4 requires Java 17)
      # This mirrors upstream CIâ€™s Java selection for Spark 4.x
      - name: Download Java (temurin@17)
        id: download-java-temurin-17
        uses: typelevel/download-java@v2
        with:
          distribution: temurin
          java-version: 17

      - name: Setup Java (temurin@17)
        uses: actions/setup-java@v5
        with:
          distribution: jdkfile
          java-version: 17
          jdkFile: ${{ steps.download-java-temurin-17.outputs.jdkFile }}

      - name: Cache Mill / Coursier / Ivy
        uses: actions/cache@v4
        with:
          path: |
            ~/.mill
            ~/.ivy2/cache
            ~/.coursier/cache/v1
            ~/.cache/coursier/v1
            ~/AppData/Local/Coursier/Cache/v1
            ~/Library/Caches/Coursier/v1
          key: ${{ runner.os }}-mill-cache-v2-${{ hashFiles('**/*.mill') }}-${{ hashFiles('project/build.properties') }}

      - name: Make mill executable
        run: chmod +x ./mill

      # Build the assembly JAR
      - name: Build assembly
        run: |
          ./mill -i spark-excel[${{ env.SCALA_VERSION }},${{ env.SPARK_VERSION }}].assembly
          echo "ASSEMBLY_DIR=$(./mill show spark-excel[${{ env.SCALA_VERSION }},${{ env.SPARK_VERSION }}].assembly | tail -n1)" >> $GITHUB_ENV

      # Upload the built jar(s)
      - name: Derive short Scala version
        run: echo "SCALA_SHORT=$(echo ${{ env.SCALA_VERSION }} | cut -d'.' -f1-2)" >> $GITHUB_ENV

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: spark_excel_${{ env.SCALA_SHORT }}_${{ env.SPARK_VERSION }}_${{ github.sha }}
          path: |
            ${{ env.ASSEMBLY_DIR }}/**/*.jar
            out/**/assembly.dest/**/*.jar
          if-no-files-found: warn
